-- building_tech = {}

-- building_tech.t_tech = {}
-- building_tech.t_tech["Q1_00"] = {"Q1_10"}
-- building_tech.t_tech["Q1_10"] = {"Q1_20", "Q1_21"}
-- building_tech.t_tech["Q1_20"] = {}
-- building_tech.t_tech["Q1_21"] = {}

-- building_tech.t_tech["Q2_00"] = {"Q2_10"}
-- building_tech.t_tech["Q2_10"] = {"Q2_20", "Q2_21"}
-- building_tech.t_tech["Q2_20"] = {}
-- building_tech.t_tech["Q2_21"] = {}

-- building_tech.t_tech["Q3_00"] = {"Q3_10"}
-- building_tech.t_tech["Q3_10"] = {"Q3_20"}
-- building_tech.t_tech["Q3_20"] = {}

-- building_tech.t_tech["Q4_00"] = {"Q4_10"}
-- building_tech.t_tech["Q4_10"] = {"Q4_20"}
-- building_tech.t_tech["Q4_20"] = {}

-- building_tech.t_tech["Q5_00"] = {"Q5_10"}
-- building_tech.t_tech["Q5_10"] = {"Q5_20","Q5_21"}
-- building_tech.t_tech["Q5_20"] = {}
-- building_tech.t_tech["Q5_21"] = {}

-- building_tech.t_tech["Q6_00"] = {"Q6_10"}
-- building_tech.t_tech["Q6_10"] = {"Q6_20","Q6_21"}
-- building_tech.t_tech["Q6_20"] = {}
-- building_tech.t_tech["Q6_21"] = {}

-- building_tech.t_tech["W1_00"] = {"W1_10", "W1_11"}
-- building_tech.t_tech["W1_10"] = {"W1_20"}
-- building_tech.t_tech["W1_20"] = {}
-- building_tech.t_tech["W1_11"] = {"W1_21"}
-- building_tech.t_tech["W1_21"] = {}

-- building_tech.t_tech["W2_00"] = {"W2_10",}
-- building_tech.t_tech["W2_10"] = {"W2_20",}
-- building_tech.t_tech["W2_20"] = {}

-- building_tech.t_tech["W3_00"] = {"W3_10",}
-- building_tech.t_tech["W3_10"] = {"W3_20",}
-- building_tech.t_tech["W3_20"] = {}

-- building_tech.t_tech["W4_00"] = {"W4_10",}
-- building_tech.t_tech["W4_10"] = {"W4_20",}
-- building_tech.t_tech["W4_20"] = {}

-- building_tech.t_tech["W5_00"] = {"W5_10",}
-- building_tech.t_tech["W5_10"] = {"W5_20","W5_21",}
-- building_tech.t_tech["W5_20"] = {}
-- building_tech.t_tech["W5_21"] = {}

-- building_tech.t_tech["E1_00"] = {"E1_10",}
-- building_tech.t_tech["E1_10"] = {}


-- building_tech.t_tech["E2_00"] = {"E2_10",}
-- building_tech.t_tech["E2_10"] = {}

-- building_tech.t_tech["G1_00"] = {"G1_10",}
-- building_tech.t_tech["G1_10"] = {}

-- building_tech.t_tech["E4_00"] = {"E4_10",}
-- building_tech.t_tech["E4_10"] = {}

-- building_tech.t_tech["E5_00"] = {"E5_10","E5_11",}
-- building_tech.t_tech["E5_10"] = {}
-- building_tech.t_tech["E5_11"] = {}

-- building_tech.t_tech["G2_00"] = {"G2_10","G2_11",}
-- building_tech.t_tech["G2_10"] = {}
-- building_tech.t_tech["G2_11"] = {}

-- building_tech.t_tech["E7_00"] = {"E7_10","E7_11",}
-- building_tech.t_tech["E7_10"] = {}
-- building_tech.t_tech["E7_11"] = {}

-- building_tech.t_tech["D1_00"] = {"D1_10",}
-- building_tech.t_tech["D1_10"] = {}

-- building_tech.t_tech["D2_00"] = {"D2_10",}
-- building_tech.t_tech["D2_10"] = {}

-- building_tech.t_tech["D3_00"] = {"D3_10",}
-- building_tech.t_tech["D3_10"] = {}

-- building_tech.t_tech["D4_00"] = {"D4_10",}
-- building_tech.t_tech["D4_10"] = {}

-- building_tech.t_tech["D5_00"] = {"D5_10",}
-- building_tech.t_tech["D5_10"] = {}

-- building_tech.t_tech["D6_00"] = {"D6_10","D6_11",}
-- building_tech.t_tech["D6_10"] = {}
-- building_tech.t_tech["D6_11"] = {}

-- building_tech.t_tech["D7_00"] = {"D7_10","D7_11",}
-- building_tech.t_tech["D7_10"] = {}
-- building_tech.t_tech["D7_11"] = {}

-- building_tech.t_tech["F1_00"] = {"F1_10",}
-- building_tech.t_tech["F1_10"] = {"F1_20",}
-- building_tech.t_tech["F1_20"] = {}

-- building_tech.t_tech["F2_00"] = {"F2_10",}
-- building_tech.t_tech["F2_10"] = {}

-- building_tech.t_tech["F3_00"] = {"F3_10","F3_11",}
-- building_tech.t_tech["F3_10"] = {}
-- building_tech.t_tech["F3_11"] = {}

-- building_tech.t_tech["F4_00"] = {"F4_10","F4_11",}
-- building_tech.t_tech["F4_10"] = {}
-- building_tech.t_tech["F4_11"] = {}

-- building_tech.t_tech["F5_00"] = {"F5_10",}
-- building_tech.t_tech["F5_10"] = {}

-- building_tech.t_tech["F6_00"] = {"F6_10","F6_11"}
-- building_tech.t_tech["F6_10"] = {}
-- building_tech.t_tech["F6_11"] = {}

-- building_tech.t_tech["G3_00"] = {"G3_10","G3_11"}
-- building_tech.t_tech["G3_10"] = {}
-- building_tech.t_tech["G3_11"] = {}

-- building_tech.t_tech["R1_00"] = {"R1_10","R1_11",}
-- building_tech.t_tech["R1_10"] = {}
-- building_tech.t_tech["R1_11"] = {}

-- building_tech.t_tech["R2_00"] = {"R2_10","R2_11",}
-- building_tech.t_tech["R2_10"] = {}
-- building_tech.t_tech["R2_11"] = {}

-- building_tech.t_tech["R3_00"] = {"R3_10",}
-- building_tech.t_tech["R3_10"] = {}

-- building_tech.t_tech["R4_00"] = {"R4_10","R4_11",}
-- building_tech.t_tech["R4_10"] = {}
-- building_tech.t_tech["R4_11"] = {}

-- building_tech.t_tech["R5_00"] = {"R5_10",}
-- building_tech.t_tech["R5_10"] = {}

-- building_tech.t_tech["G4_00"] = {"G4_10","G4_11"}
-- building_tech.t_tech["G4_10"] = {}
-- building_tech.t_tech["G4_11"] = {}

-- building_tech.t_tech["G5_00"] = {"G5_10","G5_11"}
-- building_tech.t_tech["G5_10"] = {}
-- building_tech.t_tech["G5_11"] = {}

function building_tech:ApplyTechSkills(building)
	local buildingName = building:GetUnitName()
	local techName = string.sub(buildingName, -8, -4)
	local buildingAbilities = self.t_tech[techName]
	if buildingAbilities ~= nil then
		for k,abilityName in pairs(buildingAbilities) do
			AbilityManager:AddAndSet(building, abilityName)
		end
	end
	if string.sub(buildingName,10,10) ~= "X" then
		if not building:HasItemInInventory("item_Sale_Build") then
			if buildingName ~= "npc_unit_R8_00_RT" and buildingName ~= "npc_unit_R8_10_RT" then

				building:SetHasInventory(true)
				local item = CreateItem("item_Sale_Build", nil, nil)
				building:AddItem(item)
			end

		end
	end
	AbilityManager:AddAndSet(building, "build_base")
	building:AddAbility(techName)
end
--original functions


function buildbuilding(keys)--建筑完成
	-- target	table: 0x002c2278
	-- caster	table: 0x0026ea90
	-- caster_entindex	1926
	-- ScriptFile	scripts/vscripts/building.lua
	-- Function	buildbuilding
	-- ability	table: 0x002eea00
	local old_building = keys.caster
	local building = keys.target
	local ability = keys.ability

	local playerID = building:GetPlayerOwnerID()
	local player = PlayerResource:GetPlayer(playerID)
	local playerData = PlayerData:GetPlayerData(playerID)

	local buildPoint = old_building:GetAbsOrigin()
	local cost = ability:GetGoldCost(-1)
	local food = ability:GetManaCost(-1)
	local old_sale = old_building:GetContext("Sale")
	local old_food = old_building:GetContext("Food")
	local old_score = old_building:GetContext("Score")

	if keys.hex ~= nil then
		playerData:Save(keys.hex, true)
	end

	--加入表处理
	playerData:RemoveNewBuilding(old_building)
	playerData:ReplaceBuilding(old_building, building)
	playerData:AddNewBuilding(building)
	--设置贩售金钱
	building:SetContextNum("Sale", old_sale + cost, 0)
	building:SetContextNum("Food", old_food + food, 0)
	building:SetContextNum("Score", old_score + cost, 0)
	--增加升级
	building_tech:ApplyTechSkills(building)
	--兵力增加
	playerData:ModifyScore(cost)
	--单位建筑化
	building:SetMoveCapability(DOTA_UNIT_CAP_MOVE_NONE)
	building:SetAttackCapability(DOTA_UNIT_CAP_NO_ATTACK)
	building:SetBaseManaRegen(60)
	building:SetBaseHealthRegen(800)
	local fScale = building:GetModelScale()
	building:SetModelScale(fScale+0.25)

	--设置石化效果
	building:SetContextThink(DoUniqueString("building_stonehold"),
		function()
			if IsValidEntity(building) then
				if building:IsAlive() then
					building:FindAbilityByName("build_base"):ApplyDataDrivenModifier(building, building, "modifier_buildbase_partic", nil)
				end
			end
		end
	, 2.6)
	--设置位置和高度
	ResolveNPCPositions(building:GetAbsOrigin(), 64)
	local buildGroundPoint = GetGroundPosition(buildPoint, building)
	buildGroundPoint.z = buildGroundPoint.z + 30
	building:SetAbsOrigin(buildGroundPoint)
	--播放声音
	EmitSoundOnClient("challenge.success", player)
end

function conditions(keys)--开始建筑
	local building = keys.caster
	local ability = keys.ability

	local playerID = building:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local cost = ability:GetGoldCost(-1)
	local food = ability:GetManaCost(-1)
	local fullFood = playerData:GetFullFood()
	local curFood = playerData:GetCurFood()

	if (curFood + food) > fullFood then
		building:Stop()
		BTFGeneral:ShowError(playerID,"#NoEnoughFood","General.NoGold")--人口不足的警告信息
	end
	if playerData:IsAdherence() and (ability:GetAbilityName() == "R8_00" or ability:GetAbilityName() == "R8_10") then
		building:Stop()
		BTFGeneral:ShowError(playerID,"#NoTowerAfterGushou","")--人口不足的警告信息
	end
	if keys.hex ~= nil then
		if playerData:Load(keys.hex) then
			building:Stop()
			BTFGeneral:ShowError(playerID,"#HaveHEX","General.NoGold")
		end
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCurFood(food)
end

function CancelBuild(keys )
	local building = keys.caster
	local ability = keys.ability

	local playerID = building:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local cost = ability:GetGoldCost(-1)
	local food = ability:GetManaCost(-1)

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCurFood(-food)
end

function Xconditions(keys) --开始建筑
	local building = keys.caster
	local ability = keys.ability

	local playerID = building:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local needScore = ability:GetSpecialValueFor("NeedScore")
	local cost = ability:GetGoldCost(-1)
	local food = ability:GetManaCost(-1)
	local fullFood = playerData:GetFullFood()
	local curFood = playerData:GetCurFood()
	local score = playerData:GetScore()

	if (curFood + food) > fullFood then
		building:Stop()
		BTFGeneral:ShowError(playerID,"#NoEnoughFood","General.NoGold")--人口不足的警告信息
	end
	if score < needScore then
		building:Stop()
		BTFGeneral:ShowError(playerID,"#NoEnoughScore"..needScore,"General.NoGold")--人口不足的警告信息
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCurFood(food)
end

function SaleBuild(keys)
	local old_building = keys.caster
	local building = keys.target
	local ability = keys.ability

	local playerID = building:GetPlayerOwnerID()
	local player = PlayerResource:GetPlayer(playerID)
	local playerData = PlayerData:GetPlayerData(playerID)

	local sale = old_building:GetContext("Sale")
	local food = old_building:GetContext("Food")
	local score = old_building:GetContext("Score")

	--加入表处理
	playerData:RemoveNewBuilding(old_building)
	playerData:ReplaceBuilding(old_building, building)
	---------------------邪法的系统处理---------------------
	if old_building:GetUnitName()  == "npc_unit_Q3_2z_BB" then
		playerData:Save("hex_Q3", false)
	end
	---------------------创建新的建筑---------------------
	for i = 0, 5, 1 do
		if building:GetItemInSlot(i) then
			building:RemoveItem(building:GetItemInSlot(i))
		end
	end

	local point = building:GetAbsOrigin()
	local groundPoint = GetGroundPosition(point, building)
	groundPoint.z = groundPoint.z + 25.15
	building:SetAbsOrigin(groundPoint)

	building:SetContextNum("Score", 0, 0)
	building:SetContextNum("Sale", 0, 0)
	building:SetContextNum("Food", 0, 0)

	playerData:BuildingAddBuildAbility(building)
	building:SetBaseManaRegen(20)
	---------------------退还金钱--------------------------------
	playerData:ModifyGold(sale, DOTA_ModifyGold_Unspecified)
	---------------------金钱特效--------------------------------
	SendOverheadEventMessage(player, OVERHEAD_ALERT_GOLD, old_building, sale, player)
	---------------------退还人口--------------------------------
	playerData:ModifyCurFood(-food)
	---------------------退还兵力--------------------------------
	playerData:ModifyScore(-score)
end

function UpTechLevelStart1(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)
	local crystal = playerData:GetCrystal()

	if crystal < crystalCost then
		caster:Stop()
		BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold")
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(-crystalCost)
end
function UpTechLevelSuccess1(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local name = ability:GetAbilityName()

	caster:AddAbility("techlevel_2")
	local ab = caster:FindAbilityByName("techlevel_2")
	ab:SetLevel(1)
	caster:SwapAbilities(name, "techlevel_2", false, true)
	caster:RemoveAbility(name)

	playerData:UpgradeTech()

	BTFGeneral:ShowError(playerID,"#UpTechLevel1","ui.npe_objective_complete")--成功提示
end
function UpTechLevelCancel1(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)
	local crystal = playerData:GetCrystal()

	ability:EndCooldown()

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(crystalCost)
end

function UpTechLevelStart2(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)
	local crystal = playerData:GetCrystal()

	if crystal < crystalCost then
		caster:Stop()
		BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold")
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(-crystalCost)
end
function UpTechLevelSuccess2(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local name = ability:GetAbilityName()

	caster:AddAbility("legion_nice")
	local ab = caster:FindAbilityByName("legion_nice")
	ab:SetLevel(1)
	caster:SwapAbilities(name, "legion_nice", false, true)
	caster:RemoveAbility(name)

	playerData:UpgradeTech()

	BTFGeneral:ShowError(playerID,"#UpTechLevel2","ui.npe_objective_complete")--成功提示
end
function UpTechLevelCancel2(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)
	local crystal = playerData:GetCrystal()

	ability:EndCooldown()

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(crystalCost)
end


function UpFoodStart(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local name = ability:GetAbilityName()
	local lvnum = string.sub(name,-1,-1)
	local cost = ability:GetGoldCost(-1)
	local crystalCost = ability:GetManaCost(-1)
	local fullFood = playerData:GetFullFood()
	local crystal = playerData:GetCrystal()

	if fullFood < 288 then
		if lvnum == "2" and playerData:GetTechLevel() < 1 then
			BTFGeneral:ShowError(playerID,"#NeedTechLevel1","General.NoGold") --警告信息
			caster:Stop()
		end
		if lvnum == "3" and playerData:GetTechLevel() < 2 then
			BTFGeneral:ShowError(playerID,"#NeedTechLevel2","General.NoGold") --警告信息
			caster:Stop()
		end
		if crystal < crystalCost then
			BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold") --警告信息
			caster:Stop()
		end
	else
		BTFGeneral:ShowError(playerID,"#MaxFullFood","General.NoGold") --警告信息
		caster:Stop()
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(-crystalCost)
end

function UpFoodSuccess(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local addFullFood = keys.upfoodcount
	local name = ability:GetAbilityName()
	local lv = ability:GetLevel()
	local lvnum = string.sub(name,-1,-1)

	if lv == 7 then
		if lvnum == "1" then
			caster:AddAbility("Up_Food2")
			local ab = caster:FindAbilityByName("Up_Food2")
			ab:SetLevel(1)
			caster:SwapAbilities(name, "Up_Food2", false, true)
			caster:RemoveAbility(name)
		end
		if lvnum == "2" then
			caster:AddAbility("Up_Food3")
			local ab = caster:FindAbilityByName("Up_Food3")
			ab:SetLevel(1)
			caster:SwapAbilities(name, "Up_Food3", false, true)
			caster:RemoveAbility(name)
		end
		if lvnum == "3" then

		end
	else
		ability:SetLevel(lv+1)
	end

	playerData:ModifyFullFood(addFullFood)

	BTFGeneral:ShowError(playerID,"#UpFoodFinish","ui.npe_objective_complete")--成功提示
end


function UpFoodCancel(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)

	ability:EndCooldown()

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(crystalCost)
end


function UpCrystalTechStart(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local lv = ability:GetLevel()
	local name = ability:GetAbilityName()
	local lvnum = string.sub(name,-1,-1)
	local cost = ability:GetGoldCost(-1)
	local crystalCost = ability:GetManaCost(-1)

	local crystalTech = playerData:GetCrystalTech()
	local tech = playerData:GetTechLevel()
	local score = playerData:GetScore()
	local crystal = playerData:GetCrystal()

	if crystalTech >= 16 then
		BTFGeneral:ShowError(playerID,"#MaxTechLevel","General.NoGold") --警告信息
		caster:Stop()
	else
		if score < 2000 then
			BTFGeneral:ShowError(playerID,"#NoEnoughScore2000","General.NoGold") --警告信息
			caster:Stop()
		else
			if crystal < crystalCost then
				BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold") --警告信息
				caster:Stop()
			else
				if crystalTech >= 4 and tech < 1 then
					BTFGeneral:ShowError(playerID,"#NeedTechLevel1","General.NoGold") --警告信息
					caster:Stop()
				elseif crystalTech >= 8 and tech < 2 then
					BTFGeneral:ShowError(playerID,"#NeedTechLevel2","General.NoGold") --警告信息
					caster:Stop()
				end
			end
		end
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(-crystalCost)
end



function UpCrystalTechCancel(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local cost = ability:GetGoldCost(-1)

	ability:EndCooldown()

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCrystal(crystalCost)
end

function UpCrystalTechSuccess(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local name = ability:GetAbilityName()
	local lv = ability:GetLevel()

	if lv == 4 then
		caster:AddAbility("Up_Tech2")
		local ab = caster:FindAbilityByName("Up_Tech2")
		ab:SetLevel(1)
		caster:SwapAbilities(name, "Up_Tech2", false, true)
		caster:RemoveAbility(name)
	elseif lv == 8 then
		caster:AddAbility("Up_Tech3")
		local ab = caster:FindAbilityByName("Up_Tech3")
		ab:SetLevel(1)
		caster:SwapAbilities(name, "Up_Tech3", false, true)
		caster:RemoveAbility(name)
	else
		ability:SetLevel(lv+1)
	end

	playerData:UpgradeCrystalTech()

	BTFGeneral:ShowError(playerID,"#UpTechFinish","ui.npe_badge") --采集效率升级成功
end


function UpFarmerStart(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local food = 1
	local cost = ability:GetGoldCost(-1)

	local farmerNum = playerData:GetFarmerNumber()
	local score = playerData:GetScore()
	local curFood = playerData:GetCurFood()
	local fullFood = playerData:GetFullFood()

	if	farmerNum >= 8 then
		BTFGeneral:ShowError(playerID,"#MaxFarmerNum","General.NoGold") --最大采集者数量警告信息
		caster:Stop() --升级中断
	else
		if (curFood + food) > fullFood then
			BTFGeneral:ShowError(playerID,"#NoEnoughFood","General.NoGold")--人口不足的警告信息
			caster:Stop() --升级中断
		else
			if farmerNum < 4 then
				if score < 600 then
					BTFGeneral:ShowError(playerID,"#NoEnoughScore600","General.NoGold") --兵力不足警告信息
					caster:Stop() --升级中断
				end
			else
				if score < 1000 then
					BTFGeneral:ShowError(playerID,"#NoEnoughScore1000","General.NoGold") --兵力不足警告信息
					caster:Stop() --升级中断
				end
			end
		end
	end

	playerData:ModifyGold(-cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCurFood(food)
end

function UpFarmerCancel(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local cost = ability:GetGoldCost(-1)
	local food = ability:GetManaCost(-1)

	ability:EndCooldown()

	playerData:ModifyGold(cost, DOTA_ModifyGold_AbilityCost)
	playerData:ModifyCurFood(-food)
end


function UpFarmerSuccess(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	playerData:AddFarmer()

	ability:SetLevel(playerData:GetFarmerNumber())

	BTFGeneral:ShowError(playerID,"#UpFarmerFinish","compendium_levelup") --招募完成
end


--防卡兵
function fangkabing(keys)
	--local target = keys.target
	local caster = keys.caster
	local point = keys.target_points[1]
	local teams = DOTA_UNIT_TARGET_TEAM_BOTH
	local types = DOTA_UNIT_TARGET_BASIC
	local flags = DOTA_UNIT_TARGET_FLAG_NONE

	--获取范围内的单位
	local group = FindUnitsInRadius(caster:GetTeamNumber(),point,nil,200,teams,types,flags,FIND_UNITS_EVERYWHERE,true)
		--print("the kabing unit is  ")
		--print("group:"..#group)
	for i,target in pairs(group) do
		if target:HasAbility("build_base") == false and target:IsChanneling() == false then --筛除建筑单位
			local team_number = target:GetTeamNumber()
			local unit_point = target:GetAbsOrigin()
			--target:AddNewModifier(nil, nil, "modifier_phased", {duration=0.3})
			if team_number == DOTA_TEAM_GOODGUYS  then

						local attack_to_right = Vector(5120 , unit_point.y,unit_point.z)
						local Order =
					{                                        --发送攻击指令
						UnitIndex = target:entindex(),
						OrderType = DOTA_UNIT_ORDER_ATTACK_MOVE,
						TargetIndex = nil,
						AbilityIndex = 0,
						Position = attack_to_right,
						Queue = 0
					}
				ExecuteOrderFromTable(Order)
				--print("attack to right x is"..attack_to_right.x)
				--print("order1")
			end

			if team_number ==  DOTA_TEAM_BADGUYS  then
				local attack_to_left = Vector(-5120 , unit_point.y,unit_point.z)
				local Order2 =
					{                                        --发送攻击指令
						UnitIndex = target:entindex(),
						OrderType = DOTA_UNIT_ORDER_ATTACK_MOVE,
						TargetIndex = nil,
						AbilityIndex = 0,
						Position = attack_to_left,
						Queue = 0
					}
				ExecuteOrderFromTable(Order2)
				--print("attack to left x is"..attack_to_left.x)
				--print("order2")
			end
		end
	end
end

function ReRollBuildsStart(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)
	local crystal = playerData:GetCrystal()

	if crystal < crystalCost then
		caster:Stop()--caster:Interrupt()
		BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold") --警告信息
	else
		playerData:LookBuildings(
			function(n, building)
				if building:GetUnitName() == "npc_dummy_build_base" and building:GetPlayerOwnerID() == playerID then
					ability:ApplyDataDrivenModifier(caster, building, "modifier_rerollbuilds", nil)
				end
			end
		)
	end

	playerData:ModifyCrystal(-crystalCost)
end
function GetRandomBuildingTypeName(s_type,s_old)
	local random = AllTypes[s_type][RandomInt(1, #AllTypes[s_type])]
	while random == s_old do
		random = AllTypes[s_type][RandomInt(1, #AllTypes[s_type])]
	end
	return random
end
function ReRollBuilds(keys) --(施法单位，指定兵种[nil为所有兵种])
	local caster = keys.caster
	local ability = keys.ability
	local buildingType = keys.build_type

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	if buildingType == nil then
		--重选全部技能
		local BUILD_Q = playerData:GetBuildingTypeName("Q") --获取Q旧编号
		local BUILD_W = playerData:GetBuildingTypeName("W") --获取W旧编号
		local BUILD_E = playerData:GetBuildingTypeName("E") --获取E旧编号
		local BUILD_D = playerData:GetBuildingTypeName("D") --获取D旧编号
		local BUILD_F = playerData:GetBuildingTypeName("F") --获取F旧编号
		local BUILD_G = playerData:GetBuildingTypeName("G") --获取G旧编号
		local BUILD_R = playerData:GetBuildingTypeName("R") --获取R旧编号
		local BUILD_X = playerData:GetBuildingTypeName("X") --获取R旧编号

		playerData:SetBuildingTypeName("Q", GetRandomBuildingTypeName("Q", BUILD_Q))
		playerData:SetBuildingTypeName("W", GetRandomBuildingTypeName("W", BUILD_W))
		playerData:SetBuildingTypeName("E", GetRandomBuildingTypeName("E", BUILD_E))
		playerData:SetBuildingTypeName("D", GetRandomBuildingTypeName("D", BUILD_D))
		playerData:SetBuildingTypeName("F", GetRandomBuildingTypeName("F", BUILD_F))
		playerData:SetBuildingTypeName("G", GetRandomBuildingTypeName("G", BUILD_G))
		playerData:SetBuildingTypeName("R", GetRandomBuildingTypeName("R", BUILD_R))
		playerData:SetBuildingTypeName("X", GetRandomBuildingTypeName("X", BUILD_X))
	else
		--重选指定技能
		local x = playerData:GetBuildingTypeName(buildingType) --获取旧编号
		playerData:SetBuildingTypeName(buildingType, GetRandomBuildingTypeName(buildingType, x))
	end
	--替换函数
	playerData:UpdateBuildingsBuildAbility()

	playerData:LookBuildings(
		function(n, building)
			if building:GetUnitName() == "npc_dummy_build_base" and building:GetPlayerOwnerID() == playerID then
				building:RemoveModifierByName("modifier_rerollbuilds")
			end
		end
	)

	if ability:GetLevel() < 7 then
		-- print(Game:IsTestMode())
		if not Game:IsTestMode() then
			ability:SetLevel(ability:GetLevel()+1)
		end
	else
		caster:RemoveAbility("legion_rerollbuilds")
	end
end
function ReRollCancel(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = ability:GetManaCost(-1)

	ability:EndCooldown()

	playerData:LookBuildings(
		function(n, building)
			if building:GetUnitName() == "npc_dummy_build_base" and building:GetPlayerOwnerID() == playerID then
				building:RemoveModifierByName("modifier_rerollbuilds")
			end
		end
	)

	playerData:ModifyCrystal(crystalCost)
end

-- function BuyHire(keys)
-- 	DeepPrintTable(keys)
-- end

function zhenya(keys)
	--local target = keys.target
	local caster = keys.caster
	local point = keys.target_points[1]
	local teams = DOTA_UNIT_TARGET_TEAM_ENEMY
	local types = DOTA_UNIT_TARGET_BASIC
	local flags = DOTA_UNIT_TARGET_FLAG_MAGIC_IMMUNE_ENEMIES
	local pid = caster:GetPlayerOwnerID()
	local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_legion_commander/legion_commander_odds.vpcf", PATTACH_ABSORIGIN, caster)
	ParticleManager:SetParticleControl(particleId, 0, point)
	ParticleManager:SetParticleControlEnt(particleId, 1, caster, PATTACH_CUSTOMORIGIN_FOLLOW, "attach_attack1", caster:GetOrigin(), true)
	ParticleManager:SetParticleControl(particleId, 3, point)
	ParticleManager:SetParticleControl(particleId, 4, Vector(600,600,600))
	ParticleManager:SetParticleControl(particleId, 5, Vector(1,0,0))
	ParticleManager:SetParticleControl(particleId, 6, point)
	ParticleManager:ReleaseParticleIndex(particleId)
	--获取范围内的单位
	local group = FindUnitsInRadius(caster:GetTeamNumber(),point,nil,600,teams,types,flags,FIND_UNITS_EVERYWHERE,true)
	for i,target in pairs(group) do
		if IsValidEntity(target) then
			if target:IsAlive()  then
				if target:HasAbility("build_base") == false then --筛除建筑单位
					target:Kill(keys.ability, keys.caster)
				end
			end
		end
	end
	caster:EmitSound("Hero_LegionCommander.Overwhelming.Location")
	--替换技能
	--caster:SwapAbilities("legion_zhenya","legion_nice" , false, true)
	caster:RemoveAbility("legion_zhenya")
	AbilityManager:AddAndSet(caster,"legion_nice")
end


function NiCeStart(keys)
	local caster = keys.caster
	local target = keys.target
	local playerID = caster:GetPlayerOwnerID()

	if target:HasItemInInventory("item_Sale_Build") and target:GetPlayerOwnerID() == playerID then --建筑单位
		-- if string.sub(name,1,10) =="npc_unit_x" then
		-- 	--提示不能以神授单位雕像作为目标
		-- 	caster:Stop()
		-- else
			-- local ab_lv = target:FindAbilityByName("Sale_Build"):GetLevel()
			-- print("ab lv is "..ab_lv)
			-- if ab_lv ~= 2 then
			-- 	--提示 不能以还未出兵的雕像为目标
			-- 	BTFGeneral:ShowError(playerID,"#CantTarget","General.NoGold")
			-- 	caster:Stop()
			-- end
		-- end
	else
		--提示必须以雕像作为目标
		BTFGeneral:ShowError(playerID,"#CantTarget","General.NoGold")
		caster:Stop()
	end

end


function NiCeSuccess(keys)
	local caster = keys.caster
	local ability = keys.ability
	local old_building = keys.target

	local playerID = caster:GetPlayerOwnerID()
	local player = PlayerResource:GetPlayer(playerID)
	local playerData = PlayerData:GetPlayerData(playerID)

	local food = old_building:GetContext("Food")
	local score = old_building:GetContext("Score")
	local sale = score

	if old_building:GetUnitName()  == "npc_unit_Q3_2z_BB" then
		playerData:Save("hex_Q3", false)
	end

	---------------------创建新的建筑---------------------
	local point = old_building:GetAbsOrigin()

	local building = UnitManager:CreateUnitByName("npc_dummy_build_base", point, false, playerID, PlayerResource:GetTeam(playerID))
	building:SetControllableByPlayer(playerID, true)

	--加入表处理
	playerData:RemoveNewBuilding(old_building)
	playerData:ReplaceBuilding(old_building, building)

	local groundPoint = GetGroundPosition(point, building)
	groundPoint.z = groundPoint.z + 25.15
	building:SetAbsOrigin(groundPoint)

	building:SetContextNum("Score", 0, 0)
	building:SetContextNum("Sale", 0, 0)
	building:SetContextNum("Food", 0, 0)

	playerData:BuildingAddBuildAbility(building)
	building:SetBaseManaRegen(20)
	---------------------退还金钱--------------------------------
	playerData:ModifyGold(sale, DOTA_ModifyGold_Unspecified)
	---------------------金钱特效--------------------------------
	SendOverheadEventMessage(player, OVERHEAD_ALERT_GOLD, old_building, sale, player)
	---------------------退还人口--------------------------------
	playerData:ModifyCurFood(-food)
	---------------------退还兵力--------------------------------
	playerData:ModifyScore(-score)

	old_building:RemoveSelf()
	caster:RemoveAbility("legion_nice")
end

function gushouStart(keys)
	local caster = keys.caster
	local ability = keys.ability
	local target = keys.target

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local score = playerData:GetScore()

	if target:GetUnitName() ~= "npc_dummy_build_base" or target:GetPlayerOwnerID() ~= playerID then
		BTFGeneral:ShowError(playerID,"#CantTarget","General.NoGold")
		caster:Stop()
		return
	end

	if score < 5000 then
		BTFGeneral:ShowError(playerID,"#NoEnoughScore5000","General.NoGold")
		caster:Stop()
		return
	end

	local enemyPlayerPosition = playerData:GetFrontEnemyPlayerPosition()
	local enemyPlayerData = PlayerData:GetPlayerDataByPosition(enemyPlayerPosition)
	if enemyPlayerData ~= nil and enemyPlayerData:IsAdherence() then
		BTFGeneral:ShowError(playerID,"#CantGushou","General.NoGold")
		caster:Stop()
		return
	end
end

function gushou(keys)
	local caster = keys.caster
	local ability = keys.ability
	local old_building = keys.target

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local point = old_building:GetAbsOrigin()


	local building = UnitManager:CreateUnitByName("npc_dummy_gushoubei", point, false, playerID, PlayerResource:GetTeam(playerID))
	building:SetControllableByPlayer(playerID, true)
	building:SetMoveCapability(DOTA_UNIT_CAP_MOVE_NONE)
	building:SetAttackCapability(DOTA_UNIT_CAP_NO_ATTACK)

	playerData:ReplaceBuilding(old_building, building)

	playerData:StartAdherence(building)

	old_building:RemoveSelf()
	caster:RemoveAbility(ability:GetAbilityName())
end

function gushouCancel(keys)
	keys.ability:EndCooldown()
end

function RemoveX(keys)
	local caster = keys.target
	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	playerData:BuildingsRemoveBuildAbility("X")
end

function bannaer_remanaStart(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local manaPer = caster:GetManaPercent()
	local score = playerData:GetScore()
	local crystalCost = keys.cost
	local crystal = playerData:GetCrystal()

	if crystal >= crystalCost then
		if score < 1000 then
			BTFGeneral:ShowError(playerID,"#NoEnoughScore1000","General.NoGold") --兵力不足警告信息
			caster:Stop() --升级中断
		else
			if manaPer == 100 then
				BTFGeneral:ShowError(playerID,"#BannerManaMax","General.NoGold") --魔法已满警告信息
				caster:Stop() --升级中断
			end
		end
	else
		BTFGeneral:ShowError(playerID,"#NoEnoughLumber","General.NoGold") --水晶不足警告信息
		caster:Stop() --升级中断
	end

	playerData:ModifyCrystal(-crystalCost)
end

function bannaer_remanaCancel(keys)
	local caster = keys.caster
	local ability = keys.ability

	local playerID = caster:GetPlayerOwnerID()
	local playerData = PlayerData:GetPlayerData(playerID)

	local crystalCost = keys.cost

	ability:EndCooldown()

	playerData:ModifyCrystal(crystalCost)
end


function bannaer_remanaSuccess(keys)
	local caster = keys.caster
	local pid = caster:GetPlayerOwnerID()
	local PlayerPosition = PlayerCalc:GetPlayerPositionByID(pid)
	local mana = caster:GetMana()
	caster:SetMana(mana+10)
	caster:EmitSound("Hero_KeeperOfTheLight.ChakraMagic.Target")
end


function banner_haste(keys)
	if keys.Mode == 1 then
		local caster = keys.caster
		local Haste_Banner = keys.target

		if caster:GetTeamNumber() == DOTA_TEAM_GOODGUYS then
			Haste_Banner:SetOriginalModel("models/props_teams/banner_radiant.vmdl")
		else
			Haste_Banner:SetOriginalModel("models/props_teams/banner_dire_small.vmdl")
		end
		Haste_Banner:SetForwardVector((Vector(0,-2000,0) - Vector(0,2000,0)):Normalized())
	end
	if keys.Mode == 2 then
		local Haste_Banner = keys.target
		Haste_Banner:Kill(nil, Haste_Banner)
	end
end



function banner_lvlupCancel(keys)
	local caster = keys.caster
	local pid = caster:GetPlayerOwnerID()
	local PlayerPosition = PlayerCalc:GetPlayerPositionByID(pid)
	local money = PlayerResource:GetGold(pid)
	local cost_money = keys.ability:GetGoldCost(keys.ability:GetLevel() - 1)
---------------------退还金钱--------------------------------
	PlayerResource:SetGold(pid,money+cost_money, false)
---------------------退还CD--------------------------------
	keys.ability:EndCooldown()
end

function banner_lvlupSuccess(keys)
	local caster = keys.caster
	local pid = caster:GetPlayerOwnerID()
	local PlayerPosition = PlayerCalc:GetPlayerPositionByID(pid)
	caster:RemoveAbility("banner_lvlup")
	AbilityManager:AddAndSet(caster,"banner_slow")

end


function liejiu(keys)
	--local target = keys.target
	local caster = keys.caster
	-- caster:EmitSound("Ability.Ghostship.bell")
	--替换技能
	--caster:SwapAbilities("legion_zhenya","legion_nice" , false, true)
	caster:RemoveAbility("legion_liejiu")
	AbilityManager:AddAndSet(caster,"legion_nice")
end

function legion_shengli(keys)
	--local target = keys.target
	local caster = keys.caster
	local duration = keys.Duration
	local point = keys.target_points[1]
	local teams = DOTA_UNIT_TARGET_TEAM_FRIENDLY
	local types = DOTA_UNIT_TARGET_BASIC
	local flags = DOTA_UNIT_TARGET_FLAG_ATTACK_IMMUNE
	local pid = caster:GetPlayerOwnerID()
	caster:EmitSound("furion_furi_ability_force_05")
	EmitSoundOnLocationWithCaster(point, "Hero_Furion.ForceOfNature", caster)
	local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_furion/furion_force_of_nature_cast.vpcf", PATTACH_CUSTOMORIGIN, caster)
	ParticleManager:SetParticleControlEnt(particleId, 0, caster, PATTACH_POINT_FOLLOW, "attach_staff_base", caster:GetOrigin(), true)
	ParticleManager:SetParticleControl(particleId, 1, point)
	ParticleManager:SetParticleControl(particleId, 2, Vector( 1200, 0, 0 ))
	ParticleManager:ReleaseParticleIndex(particleId)
	--获取范围内的单位
	local group = Entities:FindAllByClassnameWithin("npc_dota_creature", point , 1200)
	for i,target in pairs(group) do
		if IsValidEntity(target) then
			if target:IsAlive()  then
				if target:HasAbility("build_base") == true and target:GetPlayerOwnerID() == pid and target:GetUnitName() ~= "npc_unit_R8_00_RT" and target:GetUnitName() ~= "npc_unit_R8_10_RT" then
					local CFunit = UnitManager:CreateUnitByBuilding(target)
							CFunit:SetMaximumGoldBounty(0)
							CFunit:SetMinimumGoldBounty(0)
							AddLabel(CFunit,"SummonUnit")
							local particleId = ParticleManager:CreateParticle("particles/econ/items/natures_prophet/natures_prophet_weapon_lunar/natures_prophet_weapon_lunar.vpcf", PATTACH_OVERHEAD_FOLLOW, CFunit)
							ParticleManager:SetParticleControl(particleId, 1, Vector(CFunit:GetHullRadius(),0,0))
							ParticleManager:SetParticleControlEnt(particleId, 2, CFunit, PATTACH_CUSTOMORIGIN_FOLLOW, "attach_hitloc", CFunit:GetOrigin(), true)
							local last_time = GameRules:GetGameTime()
							CFunit:SetContextThink(DoUniqueString("legion_shengli"),
								function()
									local now = GameRules:GetGameTime()
									if now - last_time >= duration then
										CFunit:ForceKill(false)
										-- if spawnunit:IsAlive() then
										-- 	spawnunit:ForceKill(false)
										-- end
										return nil
									end
									return 0
								end
							,0)
				end
			end
		end
	end
	caster:RemoveAbility("legion_shengli")
	AbilityManager:AddAndSet(caster,"legion_nice")
end